<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generate QR Kontrak - Minerva</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
    }

    /* card tengah */
    .center-card {
      margin: 24px auto;
      max-width: 1100px;
    }

    /* header tabel gradien seperti dasbor */
    .table thead th {
      background: linear-gradient(90deg, #0400DE 0%, #3A00FF 100%);
      color: #ffffff;
      text-align: center;
      vertical-align: middle;
      border-color: rgba(255,255,255,0.05);
    }

    .table tbody td {
      text-align: center;
      vertical-align: middle;
    }

    /* section QR (hidden awalnya) */
    .qr-section {
      display: none;
      margin-top: 1.5rem;
      padding: 28px;
      border-radius: .5rem;
      background: #fff;
      box-shadow: 0 6px 18px rgba(22, 28, 45, 0.06);
    }

    .qr-img {
      width: 180px;
      height: 180px;
      object-fit: contain;
    }

    .id-label {
      color: #0400DE;
      font-weight: 700;
    }

    /* tombol warna dashboard (opsional) */
    .btn-dashboard {
      background-color: #0400DE;
      color: #fff;
      border: none;
    }
    .btn-dashboard:hover { background-color: #0300b3; color: #fff; }
  </style>
</head>
<body>
  <div class="container center-card">

    <div class="text-center mb-4">
      <h3 class="mb-1"><i class="bi bi-qr-code"></i> Generate QR Kontrak</h3>
      <p class="text-muted mb-0">Pilih kontrak lalu klik <b>Generate QR</b> untuk menampilkan dan mengunduh QR code.</p>
    </div>

    <div class="card">
      <div class="card-body">
        <!-- Tabel kontrak (dibuat dari data JS) -->
        <div class="table-responsive">
          <table id="contractsTable" class="table table-bordered mb-0">
            <thead>
              <tr>
                <th style="width:48%;">ID Kontrak</th>
                <th style="width:34%;">Perusahaan</th>
                <th style="width:18%;">Aksi</th>
              </tr>
            </thead>
            <tbody>
              <!-- diisi oleh JS -->
            </tbody>
          </table>
        </div>

        <!-- QR Section (hidden awalnya) -->
        <div id="qrSection" class="qr-section text-center">
          <h5 class="mb-3">QR Code Kontrak</h5>

          <div class="d-flex justify-content-center mb-3">
            <img id="qrImage" class="qr-img" alt="QR Code Kontrak">
          </div>

          <p class="mb-3">ID: <span id="qrContractId" class="id-label"></span></p>

          <div>
            <a id="downloadQrBtn" class="btn btn-success btn-sm me-2" role="button" download>
              <i class="bi bi-download"></i> Unduh QR
            </a>
            <button id="closeQrBtn" class="btn btn-outline-secondary btn-sm">Tutup</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Dummy data kontrak (ganti dengan data nyata dari server jika perlu)
    const contracts = [
      { id: "KONTRAK_26092025_001", perusahaan: "PT Alpha" },
      { id: "KONTRAK_26092025_002", perusahaan: "PT Beta" }
    ];

    // element refs
    const tbody = document.querySelector("#contractsTable tbody");
    const qrSection = document.getElementById("qrSection");
    const qrImage = document.getElementById("qrImage");
    const qrContractIdEl = document.getElementById("qrContractId");
    const downloadQrBtn = document.getElementById("downloadQrBtn");
    const closeQrBtn = document.getElementById("closeQrBtn");

    // menyimpan objectURL sebelumnya agar bisa direvoke
    let prevObjectUrl = null;

    // render tabel
    function renderTable() {
      tbody.innerHTML = "";
      contracts.forEach((c) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="text-start ps-4">${c.id}</td>
          <td>${c.perusahaan}</td>
          <td>
            <button class="btn btn-primary btn-sm generate-btn" data-id="${c.id}">
              <i class="bi bi-qr-code"></i> Generate QR
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // set event listener untuk semua tombol generate
      document.querySelectorAll(".generate-btn").forEach(btn => {
        btn.addEventListener("click", onGenerateClick);
      });
    }

    // saat klik Generate
    async function onGenerateClick(e) {
      const btn = e.currentTarget;
      const contractId = btn.getAttribute("data-id");
      if (!contractId) return;

      // disable tombol sementara
      btn.disabled = true;
      const originalHtml = btn.innerHTML;
      btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Membuat...`;

      // isi QR harus JSON agar kompatibel jika nanti di-scan pakai reader yang menunggu JSON
      const qrData = JSON.stringify({ contractId });

      // gunakan API qrserver untuk membuat QR image (size bisa dikustom)
      const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?data=' + encodeURIComponent(qrData) + '&size=300x300';

      try {
        // fetch image sebagai blob -> buat objectURL untuk image & download
        const resp = await fetch(apiUrl);
        if (!resp.ok) throw new Error("Gagal membuat QR (network).");
        const blob = await resp.blob();

        // revoke prev object url
        if (prevObjectUrl) {
          URL.revokeObjectURL(prevObjectUrl);
        }

        const objUrl = URL.createObjectURL(blob);
        prevObjectUrl = objUrl;

        // set image & download link
        qrImage.src = objUrl;
        downloadQrBtn.href = objUrl;
        downloadQrBtn.download = contractId + ".png";
        qrContractIdEl.textContent = contractId;

        // tampilkan section QR
        qrSection.style.display = "block";
        // scroll ke QR (opsional)
        qrSection.scrollIntoView({ behavior: "smooth", block: "center" });
      } catch (err) {
        console.error(err);
        alert("Gagal generate QR. Coba lagi.");
      } finally {
        // restore tombol
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    }

    // tombol tutup QR
    closeQrBtn.addEventListener("click", () => {
      qrSection.style.display = "none";
      // revoke objectURL supaya tidak bocor memori
      if (prevObjectUrl) {
        URL.revokeObjectURL(prevObjectUrl);
        prevObjectUrl = null;
      }
      qrImage.src = "";
      qrContractIdEl.textContent = "";
    });

    // initial render
    renderTable();
  </script>
</body>
</html>
