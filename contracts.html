<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Kontrak - Minerva</title>
    
    <!-- Favicon and Logo -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="shortcut icon" href="logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body data-theme="light" class="contracts-page">
    <div class="dashboard-container">
        <!-- Mobile sidebar overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>Minerva</h3>
                <!-- Mobile sidebar close button -->
                <button id="mobileSidebarClose" class="mobile-sidebar-close" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
                <!-- Desktop sidebar toggle hidden - focus on mobile only -->
                <!-- <button id="sidebarToggle" class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button> -->
            </div>
            <nav class="sidebar-nav">
                <ul id="sidebarNav" class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="contracts.html">
                            <i class="fas fa-file-contract"></i>
                            <span>Manajemen Kontrak</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="gps-tracking.html">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>GPS Tracking</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ai.html">
                            <i class="fas fa-robot"></i>
                            <span>AI Assistant</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="komunikasi.html">
                            <i class="fas fa-comments"></i>
                            <span>Komunikasi</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="billing.html">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>E-Billing</span>
                        </a>
                    </li>

                </ul>
            </nav>
        </div>

        <div id="mainContent" class="main-content">
            <nav class="top-navbar">
                <div class="container-fluid">
                    <div class="row align-items-center w-100%">
                        <div class="col">
                            <div class="d-flex align-items-center">
                                <!-- Mobile sidebar toggle button - moved to leftmost position -->
                                <button id="mobileSidebarToggle" class="mobile-sidebar-toggle me-3" onclick="toggleSidebar()">
                                    <i class="fas fa-bars"></i>
                                </button>
                                <img src="logo.png" alt="Logo" class="navbar-logo me-3" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="logo-fallback" style="display: none;">M</div>
                                <div>
                                    <h4 class="mb-0">Manajemen Kontrak</h4>
                                    <small class="text-muted d-none d-sm-inline">Kelola semua kontrak proyek dengan efisien</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto d-flex gap-2">
                            <button class="btn btn-outline-info btn-sm" onclick="showActivityLog()" title="Activity Log">
                                <i class="fas fa-history"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-sm" title="Toggle Language">
                                <i class="fas fa-globe" id="languageIcon"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleTheme()" title="Toggle Theme">
                                <i class="fas fa-moon" id="themeIconNavbar"></i>
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-outline-primary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user me-1"></i><span id="currentUser">username</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="content-area">

        <!-- Action Buttons -->
        <div class="action-buttons mb-4">
            <button class="btn btn-primary" onclick="showCreateContractModal()">
                <i class="fas fa-plus me-2"></i><span class="d-none d-sm-inline">Tambah Kontrak Baru</span><span class="d-inline d-sm-none">Tambah</span>
            </button>
            <button class="btn btn-outline-secondary" onclick="exportContracts()">
                <i class="fas fa-download me-2"></i><span class="d-none d-sm-inline">Export Kontrak</span><span class="d-inline d-sm-none">Export</span>
            </button>
            <button class="btn btn-outline-info" onclick="refreshContracts()">
                <i class="fas fa-sync me-2"></i><span class="d-none d-sm-inline">Refresh</span><span class="d-inline d-sm-none">Refresh</span>
            </button>
        </div>

        <!-- QR Scanner Section -->
        <div class="qr-scanner-section mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-qrcode me-2"></i>QR Scanner
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        <div class="col-12 col-md-6">
                            <div class="d-flex gap-2 mb-3">
                                <button id="startCameraBtn" class="btn btn-primary btn-sm">
                                    <i class="fas fa-camera me-2"></i>Start Camera
                                </button>
                                <button id="stopCameraBtn" class="btn btn-danger btn-sm d-none">
                                    <i class="fas fa-stop me-2"></i>Stop Camera
                                </button>
                                <button id="uploadImageBtn" class="btn btn-success btn-sm">
                                    <i class="fas fa-upload me-2"></i>Upload Image
                                </button>
                                <button id="pasteImageBtn" class="btn btn-info btn-sm">
                                    <i class="fas fa-paste me-2"></i>Paste Image
                                </button>
                            </div>
                            <input type="file" id="qrFileInput" accept="image/*" style="display: none;">
                            <div id="previewWrapper" style="display: none;" class="mb-3">
                                <div class="position-relative">
                                    <img id="imagePreview" class="img-fluid rounded d-none" style="max-height: 200px;">
                                    <video id="videoPreview" class="img-fluid rounded d-none" autoplay playsinline style="max-height: 200px;"></video>
                                    <canvas id="qrCanvas" style="display: none;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="qr-result">
                                <label class="form-label">Hasil Scan QR:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="qrScanResult" placeholder="Hasil scan QR akan muncul di sini..." readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearQRResult()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="text-muted">QR code yang berhasil di-scan akan otomatis masuk ke pencarian kontrak</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Stats -->
        <div class="row mb-4">
            <div class="col-6 col-sm-6 col-lg-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalContracts">0</div>
                        <div class="stat-label">Total Kontrak</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-sm-6 col-lg-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock text-warning"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="pendingContracts">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-sm-6 col-lg-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="activeContracts">0</div>
                        <div class="stat-label">Aktif</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-sm-6 col-lg-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="expiringContracts">0</div>
                        <div class="stat-label">Kadaluarsa</div>
                    </div>
                </div>
            </div>
        </div>

         <!-- Filter and Search -->
         <div class="contract-filters mb-4">
             <div class="row g-3 align-items-center justify-content-between">
                 <div class="col-12 col-sm-6 col-md-4">
                     <div class="input-group">
                         <span class="input-group-text">
                             <i class="fas fa-search"></i>
                         </span>
                         <input type="text" class="form-control" id="contractSearch" placeholder="Cari kontrak...">
                     </div>
                 </div>
                 <div class="col-12 col-md-3">
                     <select class="form-select" id="statusFilter">
                         <option value="">Semua Status</option>
                         <option value="draft">Draft</option>
                         <option value="pending">Pending</option>
                         <option value="active">Aktif</option>
                         <option value="completed">Selesai</option>
                         <option value="expired">Kadaluarsa</option>
                     </select>
                 </div>
                 <div class="col-12 col-md-3">
                     <select class="form-select" id="typeFilter">
                         <option value="">Semua Jenis</option>
                         <option value="Logistik">Logistik</option>
                         <option value="Penyimpanan">Penyimpanan</option>
                         <option value="Bongkar Muat">Bongkar Muat</option>
                         <option value="Transportasi">Transportasi</option>
                     </select>
                 </div>
                 <div class="col-12 col-md-2">
                     <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                         <i class="fas fa-filter me-1"></i><span class="d-none d-sm-inline">Filter</span>
                     </button>
                 </div>
             </div>
         </div>

        <!-- Contracts Table -->
        <div class="contracts-table-container">
            <div class="table-responsive" style="overflow-x: auto; overflow-y: visible;">
                <table class="table table-hover contracts-table" style="min-width: 1200px; width: 100%;">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th style="min-width: 50px; position: sticky; left: 0;  z-index: 10;">
                                <input type="checkbox" id="selectAllContracts" onchange="toggleSelectAll()">
                            </th>
                            <th style="min-width: 150px;">No. Kontrak</th>
                            <th style="min-width: 200px;">Nama Proyek</th>
                            <th style="min-width: 120px;">Jenis</th>
                            <th style="min-width: 150px;">Nilai Kontrak</th>
                            <th style="min-width: 130px;">Tanggal Mulai</th>
                            <th style="min-width: 130px;">Tanggal Selesai</th>
                            <th style="min-width: 100px;">Status</th>
                            <th style="min-width: 300px; position: sticky; right: 0; ; z-index: 10;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="contractsTableBody">
                        <!-- Contract rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions mt-3" id="bulkActions" style="display: none;">
            <div class="alert alert-info d-flex align-items-center justify-content-between">
                <span><i class="fas fa-info-circle me-2"></i><span id="selectedCount">0</span> kontrak dipilih</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="bulkExport()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="bulkArchive()">
                        <i class="fas fa-archive me-1"></i>Archive
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">
                        <i class="fas fa-trash me-1"></i>Hapus
                    </button>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-container mt-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="pagination-info">
                        <span class="text-muted">
                            Menampilkan <span id="showingStart">1</span> - <span id="showingEnd">10</span> 
                            dari <span id="totalRecords">0</span> kontrak
                        </span>
                    </div>
                </div>
                <div class="col-md-6">
                    <nav aria-label="Pagination Navigation">
                        <ul class="pagination justify-content-end mb-0" id="pagination">
                            <!-- Pagination items will be generated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Rules Information Modal -->
    <div class="modal fade" id="rulesInfoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Aturan dan Ketentuan Kontrak</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Standar Kepabeanan & Karantina</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>Semua barang harus memiliki dokumen kepabeanan yang lengkap</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Pemeriksaan karantina wajib dilakukan untuk barang tertentu</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Dokumen import/export harus sesuai dengan regulasi yang berlaku</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Tarif bea masuk dan pajak harus dihitung dengan benar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Aturan Keselamatan & Keamanan</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>Standar keamanan transportasi harus dipatuhi</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Prosedur keselamatan kerja wajib diterapkan</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Asuransi kargo harus sesuai dengan nilai barang</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Protokol keamanan gudang dan penyimpanan</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Ketentuan Risiko & Force Majeure</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>Risiko kerugian menjadi tanggung jawab pihak yang bersangkutan</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Force majeure meliputi bencana alam, perang, dan kebijakan pemerintah</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Pemberitahuan force majeure maksimal 7 hari kerja</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Pembagian risiko harus jelas dan tertulis</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Syarat Perpanjangan atau Terminasi</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>Perpanjangan kontrak harus disetujui 30 hari sebelum berakhir</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Terminasi dini memerlukan pemberitahuan 60 hari sebelumnya</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Denda terminasi dini sesuai dengan ketentuan kontrak</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Penyelesaian kewajiban harus tuntas sebelum terminasi</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="proceedToMethodSelection()">
                        <i class="fas fa-arrow-right me-2"></i>Lanjutkan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Method Selection Modal -->
    <div class="modal fade" id="methodSelectionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Tambah Kontrak Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h6 class="mb-4">Pilih metode penambahan kontrak:</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="method-card" onclick="selectMethod('form')">
                                <div class="method-icon">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <h6>Isi Form Manual</h6>
                                <p class="text-muted">Isi data kontrak secara manual menggunakan form</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="method-card" onclick="selectMethod('excel')">
                                <div class="method-icon">
                                    <i class="fas fa-file-excel"></i>
                                </div>
                                <h6>Upload Excel</h6>
                                <p class="text-muted">Upload dokumen Excel yang berisi data kontrak</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Contract Form Modal -->
    <div class="modal fade" id="createContractModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Isi Form Kontrak</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createContractForm">
                        <!-- Informasi Dasar Kontrak -->
                        <div class="section-header mb-3">
                            <h6><i class="fas fa-info-circle me-2"></i>Informasi Dasar Kontrak</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="namaProyek" class="form-label"><i class="fas fa-project-diagram me-2"></i>Nama Proyek/Logistik</label>
                                    <input type="text" class="form-control" id="namaProyek" placeholder="Masukkan nama proyek atau logistik" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="jenisKontrak" class="form-label"><i class="fas fa-tags me-2"></i>Jenis Kontrak</label>
                                    <select class="form-select" id="jenisKontrak" required>
                                        <option value="">Pilih Jenis Kontrak</option>
                                        <option value="Logistik">Logistik</option>
                                        <option value="Penyimpanan">Penyimpanan</option>
                                        <option value="Bongkar Muat">Bongkar Muat</option>
                                        <option value="Transportasi">Transportasi</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Tanggal Kontrak -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tglMulai" class="form-label"><i class="fas fa-calendar-alt me-2"></i>Tanggal Mulai</label>
                                    <input type="date" class="form-control" id="tglMulai" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tglSelesai" class="form-label"><i class="fas fa-calendar-check me-2"></i>Tanggal Selesai</label>
                                    <input type="date" class="form-control" id="tglSelesai" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="kontakResmi" class="form-label"><i class="fas fa-phone me-2"></i>Kontak Resmi</label>
                                    <div class="input-group">
                                        <select class="form-select" id="countryCode" style="max-width: 120px;">
                                            <option value="+62">ðŸ‡®ðŸ‡© +62</option>
                                            <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                                            <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                                            <option value="+65">ðŸ‡¸ðŸ‡¬ +65</option>
                                            <option value="+60">ðŸ‡²ðŸ‡¾ +60</option>
                                            <option value="+66">ðŸ‡¹ðŸ‡­ +66</option>
                                            <option value="+63">ðŸ‡µðŸ‡­ +63</option>
                                            <option value="+84">ðŸ‡»ðŸ‡³ +84</option>
                                            <option value="+86">ðŸ‡¨ðŸ‡³ +86</option>
                                            <option value="+81">ðŸ‡¯ðŸ‡µ +81</option>
                                            <option value="+82">ðŸ‡°ðŸ‡· +82</option>
                                            <option value="+61">ðŸ‡¦ðŸ‡º +61</option>
                                            <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
                                            <option value="+33">ðŸ‡«ðŸ‡· +33</option>
                                            <option value="+39">ðŸ‡®ðŸ‡¹ +39</option>
                                            <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
                                            <option value="+31">ðŸ‡³ðŸ‡± +31</option>
                                            <option value="+46">ðŸ‡¸ðŸ‡ª +46</option>
                                            <option value="+47">ðŸ‡³ðŸ‡´ +47</option>
                                            <option value="+45">ðŸ‡©ðŸ‡° +45</option>
                                            <option value="+41">ðŸ‡¨ðŸ‡­ +41</option>
                                            <option value="+43">ðŸ‡¦ðŸ‡¹ +43</option>
                                            <option value="+32">ðŸ‡§ðŸ‡ª +32</option>
                                            <option value="+351">ðŸ‡µðŸ‡¹ +351</option>
                                            <option value="+30">ðŸ‡¬ðŸ‡· +30</option>
                                            <option value="+90">ðŸ‡¹ðŸ‡· +90</option>
                                            <option value="+7">ðŸ‡·ðŸ‡º +7</option>
                                            <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
                                            <option value="+92">ðŸ‡µðŸ‡° +92</option>
                                            <option value="+880">ðŸ‡§ðŸ‡© +880</option>
                                            <option value="+94">ðŸ‡±ðŸ‡° +94</option>
                                            <option value="+977">ðŸ‡³ðŸ‡µ +977</option>
                                            <option value="+975">ðŸ‡§ðŸ‡¹ +975</option>
                                            <option value="+960">ðŸ‡²ðŸ‡» +960</option>
                                            <option value="+93">ðŸ‡¦ðŸ‡« +93</option>
                                            <option value="+98">ðŸ‡®ðŸ‡· +98</option>
                                            <option value="+964">ðŸ‡®ðŸ‡¶ +964</option>
                                            <option value="+965">ðŸ‡°ðŸ‡¼ +965</option>
                                            <option value="+973">ðŸ‡§ðŸ‡­ +973</option>
                                            <option value="+974">ðŸ‡¶ðŸ‡¦ +974</option>
                                            <option value="+971">ðŸ‡¦ðŸ‡ª +971</option>
                                            <option value="+968">ðŸ‡´ðŸ‡² +968</option>
                                            <option value="+966">ðŸ‡¸ðŸ‡¦ +966</option>
                                        </select>
                                        <input type="tel" class="form-control" id="kontakResmi" placeholder="Masukkan nomor telepon" pattern="[0-9\s\-\(\)]+" title="Hanya angka, spasi, tanda hubung, dan tanda kurung yang diperbolehkan" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nilai Kontrak -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-money-bill-wave me-2"></i>Nilai Kontrak</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nilaiKontrak" class="form-label"><i class="fas fa-money-bill me-2"></i>Nilai Kontrak</label>
                                    <div class="input-group">
                                        <span class="input-group-text" id="currencySymbol">Rp</span>
                                        <input type="number" class="form-control" id="nilaiKontrak" step="0.01" placeholder="Masukkan nilai kontrak" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mataUang" class="form-label"><i class="fas fa-coins me-2"></i>Mata Uang</label>
                                    <select class="form-select" id="mataUang" required>
                                        <option value="IDR">IDR - Rupiah Indonesia</option>
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="SGD">SGD - Singapore Dollar</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Informasi Perusahaan -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-building me-2"></i>Informasi Perusahaan</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="namaPic" class="form-label"><i class="fas fa-user-tie me-2"></i>Nama PIC</label>
                                    <input type="text" class="form-control" id="namaPic" placeholder="Nama lengkap Person in Charge">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="npwp" class="form-label"><i class="fas fa-id-card me-2"></i>NPWP</label>
                                    <input type="text" class="form-control" id="npwp" maxlength="25" placeholder="Nomor Pokok Wajib Pajak">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="alamat" class="form-label"><i class="fas fa-map-marker-alt me-2"></i>Alamat Perusahaan</label>
                            <textarea class="form-control" id="alamat" rows="3" placeholder="Masukkan alamat lengkap perusahaan"></textarea>
                        </div>

                        <!-- Asuransi -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-shield-alt me-2"></i>Asuransi</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="asuransi">
                                    <label class="form-check-label" for="asuransi">
                                        <i class="fas fa-shield-alt me-2"></i>Dengan Asuransi
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Empty column for alignment -->
                            </div>
                        </div>

                        <!-- Pembayaran -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-credit-card me-2"></i>Informasi Pembayaran</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="terminPembayaran" class="form-label"><i class="fas fa-calendar-week me-2"></i>Termin Pembayaran</label>
                                    <select class="form-select" id="terminPembayaran" required>
                                        <option value="">Pilih Termin Pembayaran</option>
                                        <option value="DP">DP (Down Payment)</option>
                                        <option value="Cicilan">Cicilan</option>
                                        <option value="Pelunasan">Pelunasan</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="metodePembayaran" class="form-label"><i class="fas fa-money-check me-2"></i>Metode Pembayaran</label>
                                    <select class="form-select" id="metodePembayaran" required>
                                        <option value="">Pilih Metode Pembayaran</option>
                                        <option value="Transfer Bank">Transfer Bank</option>
                                        <option value="LC">Letter of Credit (LC)</option>
                                        <option value="Cash">Cash</option>
                                        <option value="Cek">Cek</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Pajak dan Penalti -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-calculator me-2"></i>Pajak dan Penalti</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ppn" class="form-label"><i class="fas fa-percentage me-2"></i>PPN (%)</label>
                                    <input type="number" class="form-control" id="ppn" step="0.01" value="11.00" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="pajakLainnya" class="form-label"><i class="fas fa-receipt me-2"></i>Pajak Lainnya</label>
                                    <div class="input-group">
                                        <span class="input-group-text" id="pajakCurrencySymbol">Rp</span>
                                        <input type="number" class="form-control" id="pajakLainnya" step="0.01" value="0" placeholder="Nilai pajak tambahan (opsional)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="penaltiTerlambat" class="form-label"><i class="fas fa-exclamation-triangle me-2"></i>Penalti Terlambat</label>
                                    <div class="input-group">
                                        <span class="input-group-text" id="penaltiCurrencySymbol">Rp</span>
                                        <input type="number" class="form-control" id="penaltiTerlambat" step="0.01" value="0" placeholder="Nilai penalti per hari (opsional)">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hariPenalti" class="form-label"><i class="fas fa-calendar-times me-2"></i>Hari Penalti</label>
                                    <input type="number" class="form-control" id="hariPenalti" value="0" placeholder="Jumlah hari keterlambatan (opsional)">
                                </div>
                            </div>
                        </div>

                        <!-- Dokumen Lampiran -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-paperclip me-2"></i>Dokumen Lampiran</h6>
                        </div>
                        <div class="mb-3">
                            <input type="file" class="form-control" id="dokumenLampiran" multiple accept=".pdf,.doc,.docx,.xlsx,.xls,.csv,.jpg,.jpeg,.png,.txt,.rtf">
                            <small class="form-text text-muted">Upload dokumen pendukung (PDF, DOC, DOCX, Excel, CSV, JPG, PNG, TXT, RTF)</small>
                        </div>
                        
                        <!-- Barang Section -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-boxes me-2"></i>Daftar Barang</h6>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button type="button" class="btn btn-outline-primary" onclick="addBarangToContract()">
                                <i class="fas fa-plus me-2"></i>Tambah Barang
                            </button>
                            <span class="text-muted">
                                Total: <span id="contractBarangCount">0</span> barang
                            </span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm" id="contractBarangTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>No</th>
                                        <th>Jenis Barang</th>
                                        <th>Volume (mÂ³)</th>
                                        <th>Berat (kg)</th>
                                        <th>Jumlah Kontainer</th>
                                        <th>Ukuran (ft)</th>
                                        <th>Nomor Kontainer</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="contractBarangTableBody">
                                    <!-- Barang data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="createContract()">
                        <i class="fas fa-save me-2"></i>Simpan Kontrak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Upload Modal -->
    <div class="modal fade" id="excelUploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-excel me-2"></i>Upload Dokumen Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Template Download Section -->
                    <div class="template-section mb-4">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle me-3"></i>
                                <div>
                                    <strong>Download Template Excel</strong>
                                    <p class="mb-0">Gunakan template Excel berikut untuk memastikan format data yang benar</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-success" onclick="downloadTemplate()">
                                <i class="fas fa-download me-2"></i>Download Template Excel
                            </button>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Upload Section -->
                    <div class="upload-section">
                        <h6 class="mb-3"><i class="fas fa-upload me-2"></i>Upload Dokumen Excel</h6>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <h6>Drag & Drop file Excel/CSV di sini</h6>
                                <p class="text-muted">atau klik untuk memilih file</p>
                                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display: none;">
                                <button class="btn btn-outline-primary" onclick="document.getElementById('excelFile').click()">
                                    <i class="fas fa-file me-2"></i>Pilih File Excel/CSV
                                </button>
                            </div>
                        </div>
                        <div id="fileInfo" class="file-info mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <span id="fileName"></span> siap diupload
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div id="previewSection" class="preview-section mt-4" style="display: none;">
                        <h6 class="mb-3"><i class="fas fa-eye me-2"></i>Preview Data</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered" id="previewTable">
                                <thead class="table-light">
                                    <tr id="previewHeaders"></tr>
                                </thead>
                                <tbody id="previewBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="uploadBtn" onclick="uploadExcel()" disabled>
                        <i class="fas fa-upload me-2"></i>Upload & Import Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Details Modal -->
    <div class="modal fade" id="contractDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Detail Kontrak</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="contractDetailsContent">
                    <!-- Contract details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-danger" onclick="deleteContract()">
                        <i class="fas fa-trash me-2"></i>Hapus
                    </button>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SheetJS for Excel/CSV reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- jsQR for QR code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- SweetAlert2 for enhanced alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="contracts.js"></script>
    <style>
        /* Risk Analysis Styles */
        .risk-stat {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .risk-stat.high-risk {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .risk-stat.medium-risk {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .risk-stat.low-risk {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
            margin-top: 10px;
        }
        
        .heatmap-item {
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .heatmap-item:hover {
            transform: scale(1.05);
        }
        
        .heatmap-item.high-risk {
            background-color: #dc3545;
            color: white;
        }
        
        .heatmap-item.medium-risk {
            background-color: #ffc107;
            color: #212529;
        }
        
        .heatmap-item.low-risk {
            background-color: #28a745;
            color: white;
        }
        
        .clause-analysis {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .clause-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .clause-item.success {
            background-color: #d1e7dd;
            border-left-color: #28a745;
        }
        
        .clause-item.danger {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .clause-item.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .clause-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        /* Approval Workflow Styles */
        .approval-levels {
            margin-top: 15px;
        }
        
        .level-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .level-item.completed {
            color: #28a745;
        }
        
        .level-item i {
            margin-right: 10px;
            width: 20px;
        }
        
        .timeline-approval {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .approval-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .approval-item.success {
            background-color: #d1e7dd;
            border-left-color: #28a745;
        }
        
        .approval-item.danger {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .approval-marker {
            margin-right: 15px;
            margin-top: 5px;
        }
        
        .approval-content h6 {
            margin-bottom: 5px;
        }
        
        /* Timeline Styles */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-marker {
            position: absolute;
            left: -22px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #6c757d;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #dee2e6;
        }
        
        .timeline-item.completed .timeline-marker {
            background-color: #28a745;
        }
        
        .timeline-content {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .timeline-content h6 {
            margin-bottom: 5px;
            color: #495057;
        }
        
        /* Version Control Styles */
        .version-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .version-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .version-number {
            font-weight: bold;
            color: #007bff;
        }
        
        .version-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .version-changes {
            margin-bottom: 5px;
            color: #495057;
        }
        
        .version-author {
            color: #6c757d;
            font-style: italic;
        }
        
        /* Workflow Styles */
        .workflow-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .workflow-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .workflow-item.approved {
            background-color: #d1e7dd;
            border-left-color: #28a745;
        }
        
        .workflow-item.rejected {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .workflow-marker {
            margin-right: 15px;
            margin-top: 5px;
        }
        
        .workflow-content h6 {
            margin-bottom: 5px;
        }
        
        /* Flexible Table Styles */
        .contracts-table-container {
            position: relative;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table-responsive {
            position: relative;
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #6c757d #f8f9fa;
        }
        
        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #6c757d;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #495057;
        }
        
        .contracts-table {
            margin-bottom: 0;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .contracts-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #0d6efd;
            color: white;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        .contracts-table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        .contracts-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .contracts-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .contracts-table tbody tr:nth-child(even):hover {
            background-color: #e9ecef;
        }
        
        .contracts-table td {
            vertical-align: middle;
            border-bottom: 1px solid #dee2e6;
            padding: 12px 8px;
        }
        
        .contracts-table th {
            padding: 12px 8px;
        }
        
        /* Sticky column styles */
        .contracts-table th:first-child,
        .contracts-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #0d6efd;
            color: white;
            border-right: 2px solid #dee2e6;
        }
        
        .contracts-table tbody tr td:first-child {
            background-color: white;
            color: inherit;
        }
        
        .contracts-table tbody tr:nth-child(even) td:first-child {
            background-color: #f8f9fa;
        }
        
        .contracts-table tbody tr:hover td:first-child {
            background-color: #f8f9fa;
        }
        
        .contracts-table tbody tr:nth-child(even):hover td:first-child {
            background-color: #e9ecef;
        }
        
        .contracts-table th:last-child,
        .contracts-table td:last-child {
            position: sticky;
            right: 0;
            z-index: 5;
            background-color: #0d6efd;
            color: white;
            border-left: 2px solid #dee2e6;
        }
        
        .contracts-table tbody tr td:last-child {
            background-color: white;
            color: inherit;
        }
        
        .contracts-table tbody tr:nth-child(even) td:last-child {
            background-color: #f8f9fa;
        }
        
        .contracts-table tbody tr:hover td:last-child {
            background-color: #f8f9fa;
        }
        
        .contracts-table tbody tr:nth-child(even):hover td:last-child {
            background-color: #e9ecef;
        }
        
        /* Action buttons responsive */
        .action-buttons-small {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: flex-start;
            align-items: center;
        }
        
        .action-buttons-small .btn {
            margin: 1px;
            padding: 4px 6px;
            font-size: 0.75rem;
            line-height: 1.2;
            transition: all 0.2s ease;
            border-width: 1px;
        }
        
        /* Enhanced action button colors */
        .action-buttons-small .btn-outline-primary {
            color: #0d6efd;
            border-color: #0d6efd;
        }
        
        .action-buttons-small .btn-outline-primary:hover {
            background-color: #0d6efd;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
        }
        
        .action-buttons-small .btn-outline-info {
            color: #0dcaf0;
            border-color: #0dcaf0;
        }
        
        .action-buttons-small .btn-outline-info:hover {
            background-color: #0dcaf0;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
        }
        
        .action-buttons-small .btn-outline-warning {
            color: #ffc107;
            border-color: #ffc107;
        }
        
        .action-buttons-small .btn-outline-warning:hover {
            background-color: #ffc107;
            color: #212529;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }
        
        .action-buttons-small .btn-outline-success {
            color: #198754;
            border-color: #198754;
        }
        
        .action-buttons-small .btn-outline-success:hover {
            background-color: #198754;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
        }
        
        .action-buttons-small .btn-outline-secondary {
            color: #6c757d;
            border-color: #6c757d;
        }
        
        .action-buttons-small .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }
        
        .action-buttons-small .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .action-buttons-small .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }
        
        /* Icon styling */
        .action-buttons-small .btn i {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Disabled state */
        .action-buttons-small .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .contracts-table-container {
                margin: 0 -15px;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            .action-buttons-small {
                flex-direction: column;
                gap: 1px;
            }
            
            .action-buttons-small .btn {
                width: 100%;
                margin: 1px 0;
            }
        }
        
        /* Loading state */
        .table-loading {
            position: relative;
        }
        
        .table-loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        /* Empty state */
        .table-empty {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .table-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Scroll Indicators */
        .scroll-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            transition: all 0.3s ease;
            opacity: 0.3;
            pointer-events: none;
        }
        
        .scroll-indicator:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-50%) scale(1.1);
        }
        
        .scroll-indicator-left {
            left: 10px;
        }
        
        .scroll-indicator-right {
            right: 10px;
        }
        
        .scroll-indicator i {
            font-size: 14px;
        }
        
        /* Table container positioning for indicators */
        .contracts-table-container {
            position: relative;
        }
        
        /* Mobile scroll indicators */
        @media (max-width: 768px) {
            .scroll-indicator {
                width: 35px;
                height: 35px;
            }
            
            .scroll-indicator i {
                font-size: 12px;
            }
        }
        
        /* Logo styling */
        .navbar-logo {
            height: 30px;
            width: auto;
            max-width: 80px;
            object-fit: contain;
            transition: transform 0.2s ease;
        }
        
        .navbar-logo:hover {
            transform: scale(1.05);
        }
        
        @media (max-width: 768px) {
            .navbar-logo {
                height: 25px;
                max-width: 60px;
            }
        }
        
        /* Logo fallback */
        .navbar-logo:not([src]) {
            display: none;
        }
        
        .logo-fallback {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #0d6efd, #0dcaf0);
            border-radius: 8px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
    </style>
    <script>
        let currentTheme = 'light';

        // Theme toggle functionality
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            
            const themeIcon = document.getElementById('themeIconNavbar');
            
            if (currentTheme === 'dark') {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            currentTheme = savedTheme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            const themeIcon = document.getElementById('themeIconNavbar');
            
            if (currentTheme === 'dark') {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
        }

        // Initialize sidebar
        function initializeSidebar() {
            const toggleBtn = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                });
            }
        }

        // Logout function
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                localStorage.removeItem('user');
                localStorage.removeItem('role');
                window.location.href = 'index.html';
            }
        }

        // Show rules info modal first
        function showCreateContractModal() {
            const rulesModal = new bootstrap.Modal(document.getElementById('rulesInfoModal'));
            rulesModal.show();
        }

        // Proceed to method selection after rules
        function proceedToMethodSelection() {
            const rulesModal = bootstrap.Modal.getInstance(document.getElementById('rulesInfoModal'));
            rulesModal.hide();
            
            const methodModal = new bootstrap.Modal(document.getElementById('methodSelectionModal'));
            methodModal.show();
        }

        // Method selection functions
        function selectMethod(method) {
            const methodModal = bootstrap.Modal.getInstance(document.getElementById('methodSelectionModal'));
            methodModal.hide();
            
            if (method === 'form') {
                const formModal = new bootstrap.Modal(document.getElementById('createContractModal'));
                formModal.show();
            } else if (method === 'excel') {
                const excelModal = new bootstrap.Modal(document.getElementById('excelUploadModal'));
                excelModal.show();
            }
        }

        // Download Excel template
        function downloadTemplate() {
            // Create sample Excel template data based on database structure
            const templateData = [
                ['Nama Proyek', 'Jenis Kontrak', 'Tanggal Mulai', 'Tanggal Selesai', 'Nilai Kontrak', 'Mata Uang', 'Kontak Resmi', 'Nama PIC', 'NPWP', 'Alamat', 'Asuransi', 'Termin Pembayaran', 'Metode Pembayaran', 'PPN (%)', 'Pajak Lainnya', 'Penalti Terlambat', 'Hari Penalti'],
                ['Pengiriman Logistik Jakarta', 'Logistik', '2024-01-15', '2024-04-15', '25000000', 'IDR', '08123456789', 'John Doe', '12.345.678.9-012.000', 'Jl. Sudirman No. 123, Jakarta', 'Ya', 'DP', 'Transfer Bank', '11.00', '0', '100000', '7'],
                ['Penyimpanan Barang Surabaya', 'Penyimpanan', '2024-02-01', '2024-06-01', '35000000', 'IDR', '08123456788', 'Jane Smith', '98.765.432.1-098.000', 'Jl. Thamrin No. 456, Surabaya', 'Tidak', 'Cicilan', 'LC', '11.00', '500000', '150000', '10']
            ];
            
            // Convert to CSV and download
            const csvContent = templateData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'template_kontrak.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('Template Excel berhasil didownload!');
        }

        // File upload handling
        function setupFileUpload() {
            const fileInput = document.getElementById('excelFile');
            const uploadArea = document.getElementById('uploadArea');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const uploadBtn = document.getElementById('uploadBtn');

            // File input change
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Check if file is Excel or CSV for data import
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv')) {
                        handleFileSelect(file);
                    } else {
                        showError('Harap pilih file Excel (.xlsx, .xls) atau CSV (.csv) untuk import data');
                    }
                }
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    // Check if file is Excel or CSV for data import
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv')) {
                        handleFileSelect(file);
                    } else {
                        showError('Harap pilih file Excel (.xlsx, .xls) atau CSV (.csv) untuk import data');
                    }
                } else {
                    showError('Harap pilih file yang valid');
                }
            });
        }

        function handleFileSelect(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const uploadBtn = document.getElementById('uploadBtn');
            const previewSection = document.getElementById('previewSection');

            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;

            // Read the actual file
            readFileContent(file);
        }

        function readFileContent(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let data;
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    
                    if (fileExtension === 'csv') {
                        // Parse CSV
                        data = parseCSV(e.target.result);
                    } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                        // Parse Excel
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    } else {
                        showError('Format file tidak didukung. Harap gunakan Excel (.xlsx, .xls) atau CSV (.csv)');
                        return;
                    }
                    
                    if (data && data.length > 0) {
                        showPreview(data);
                    } else {
                        showError('File kosong atau tidak dapat dibaca');
                    }
                } catch (error) {
                    console.error('Error reading file:', error);
                    showError('Gagal membaca file. Pastikan file tidak rusak dan formatnya benar.');
                }
            };
            
            reader.onerror = function() {
                showError('Gagal membaca file');
            };
            
            // Read file based on type
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    // Simple CSV parsing (handles basic cases)
                    const row = line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                    result.push(row);
                }
            }
            
            return result;
        }

        function showPreview(data) {
            const previewSection = document.getElementById('previewSection');
            const previewHeaders = document.getElementById('previewHeaders');
            const previewBody = document.getElementById('previewBody');

            if (!data || data.length === 0) {
                showError('Tidak ada data yang ditemukan dalam file');
                return;
            }

            // Clear previous content
            previewHeaders.innerHTML = '';
            previewBody.innerHTML = '';

            // Use first row as headers
            const headers = data[0];
            const rows = data.slice(1);

            // Add headers
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header || 'Kolom';
                previewHeaders.appendChild(th);
            });

            // Add data rows (limit to first 10 rows for preview)
            const previewRows = rows.slice(0, 10);
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach((header, index) => {
                    const td = document.createElement('td');
                    td.textContent = row[index] || '';
                    tr.appendChild(td);
                });
                previewBody.appendChild(tr);
            });

            // Show total rows info
            if (rows.length > 10) {
                const infoRow = document.createElement('tr');
                const infoCell = document.createElement('td');
                infoCell.colSpan = headers.length;
                infoCell.textContent = `... dan ${rows.length - 10} baris lainnya`;
                infoCell.style.textAlign = 'center';
                infoCell.style.fontStyle = 'italic';
                infoCell.style.color = '#6c757d';
                infoRow.appendChild(infoCell);
                previewBody.appendChild(infoRow);
            }

            previewSection.style.display = 'block';
        }

        // Upload Excel function
        function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                showError('Harap pilih file Excel terlebih dahulu');
                return;
            }

            // Read and process the actual file
            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.innerHTML;
            
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memproses...';
            uploadBtn.disabled = true;

            // Read the file content
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let data;
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    
                    if (fileExtension === 'csv') {
                        data = parseCSV(e.target.result);
                    } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    } else {
                        showError('Format file tidak didukung');
                        uploadBtn.innerHTML = originalText;
                        uploadBtn.disabled = false;
                        return;
                    }
                    
                    if (data && data.length > 1) {
                        // Process the data and import contracts
                        processExcelData(data);
                        showSuccess(`Data berhasil diimport! ${data.length - 1} kontrak telah ditambahkan.`);
                        
                        // Close modal
                        const excelModal = bootstrap.Modal.getInstance(document.getElementById('excelUploadModal'));
                        excelModal.hide();

                        // Reset form
                        fileInput.value = '';
                        document.getElementById('fileInfo').style.display = 'none';
                        document.getElementById('previewSection').style.display = 'none';
                        
                        uploadBtn.innerHTML = originalText;
                        uploadBtn.disabled = false;

                        // Refresh contracts table
                        applyFilters();
                        updateContractStats();
                    } else {
                        showError('File kosong atau tidak memiliki data yang valid');
                        uploadBtn.innerHTML = originalText;
                        uploadBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error processing file:', error);
                    showError('Gagal memproses file. Pastikan format file benar.');
                    uploadBtn.innerHTML = originalText;
                    uploadBtn.disabled = false;
                }
            };
            
            reader.onerror = function() {
                showError('Gagal membaca file');
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            };
            
            // Read file based on type
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function processExcelData(data) {
            // Skip header row
            const rows = data.slice(1);
            
            rows.forEach((row, index) => {
                try {
                    // Create contract object from row data
                    const contract = {
                        id: Date.now() + index,
                        nomorKontrak: row[0] || `KONT-${Date.now()}-${index}`,
                        namaProyek: row[1] || `Proyek ${index + 1}`,
                        jenisKontrak: row[2] || 'Logistik',
                        namaPic: row[3] || 'Unknown',
                        nilaiKontrak: parseFloat(row[4]) || 0,
                        mataUang: row[5] || 'IDR',
                        tglMulai: row[6] || new Date().toISOString().split('T')[0],
                        tglSelesai: row[7] || new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'draft',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Add to contracts array
                    contracts.push(contract);
                } catch (error) {
                    console.error(`Error processing row ${index + 1}:`, error);
                }
            });
        }

        // Show error function
        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; background-color: #f8d7da !important; border-color: #f5c2c7 !important; color: #842029 !important;';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        // Initialize phone validation
        function initializePhoneValidation() {
            const phoneInput = document.getElementById('kontakResmi');
            const countryCodeSelect = document.getElementById('countryCode');
            
            if (phoneInput && countryCodeSelect) {
                // Add input event listener for real-time validation
                phoneInput.addEventListener('input', function(e) {
                    // Remove any non-numeric characters except spaces, hyphens, and parentheses
                    let value = e.target.value.replace(/[^0-9\s\-\(\)]/g, '');
                    e.target.value = value;
                });
                
                // Add keypress event listener to prevent non-numeric input
                phoneInput.addEventListener('keypress', function(e) {
                    // Allow: backspace, delete, tab, escape, enter, space, hyphen, parentheses
                    if ([8, 9, 27, 13, 32, 45, 40, 41].indexOf(e.keyCode) !== -1 ||
                        // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        (e.keyCode === 67 && e.ctrlKey === true) ||
                        (e.keyCode === 86 && e.ctrlKey === true) ||
                        (e.keyCode === 88 && e.ctrlKey === true) ||
                        // Allow: home, end, left, right, down, up
                        (e.keyCode >= 35 && e.keyCode <= 40)) {
                        return;
                    }
                    // Ensure that it is a number and stop the keypress
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                });
                
                // Add paste event listener to clean pasted content
                phoneInput.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        let value = e.target.value.replace(/[^0-9\s\-\(\)]/g, '');
                        e.target.value = value;
                    }, 0);
                });
            }
        }

        // Get full phone number with country code
        function getFullPhoneNumber() {
            const countryCode = document.getElementById('countryCode').value;
            const phoneNumber = document.getElementById('kontakResmi').value;
            return countryCode + phoneNumber;
        }

        // QR Scanner functionality
        function initializeQRScanner() {
            const startCameraBtn = document.getElementById("startCameraBtn");
            const stopCameraBtn = document.getElementById("stopCameraBtn");
            const uploadImageBtn = document.getElementById("uploadImageBtn");
            const pasteImageBtn = document.getElementById("pasteImageBtn");
            const fileInput = document.getElementById("qrFileInput");

            if (startCameraBtn) startCameraBtn.addEventListener("click", startCamera);
            if (stopCameraBtn) stopCameraBtn.addEventListener("click", stopCamera);
            if (uploadImageBtn) uploadImageBtn.addEventListener("click", () => fileInput.click());
            if (fileInput) fileInput.addEventListener("change", handleQRUpload);
            if (pasteImageBtn) pasteImageBtn.addEventListener("click", handleClipboardRead);
            document.addEventListener("paste", handleClipboardPasteEvent);
        }

        function handleQRUpload(e) {
            const file = e.target.files && e.target.files[0] ? e.target.files[0] : e?.dataTransfer?.files?.[0];
            if (!file) return;
            showImagePreviewAndScan(file);
        }

        function showImagePreviewAndScan(file) {
            const previewWrapper = document.getElementById("previewWrapper");
            const imgEl = document.getElementById("imagePreview");
            const videoEl = document.getElementById("videoPreview");
            stopCamera();
            const reader = new FileReader();
            reader.onload = function() {
                imgEl.src = reader.result;
                previewWrapper.style.display = "block";
                imgEl.classList.remove("d-none");
                videoEl.classList.add("d-none");
                setTimeout(() => decodeImageElement(imgEl), 50);
            };
            reader.readAsDataURL(file);
        }

        function decodeImageElement(imgEl){
            const canvas = document.getElementById("qrCanvas");
            const ctx = canvas.getContext("2d");
            const width = imgEl.naturalWidth || imgEl.width;
            const height = imgEl.naturalHeight || imgEl.height;
            if (!width || !height) return;
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(imgEl, 0, 0, width, height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, canvas.width, canvas.height);
            if (code) {
                onQrDecoded(code, canvas);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'QR Code tidak terbaca dari gambar',
                    confirmButtonText: 'OK'
                });
            }
        }

        async function startCamera(){
            try {
                stopCamera();
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                const videoEl = document.getElementById("videoPreview");
                const previewWrapper = document.getElementById("previewWrapper");
                const imgEl = document.getElementById("imagePreview");
                videoEl.srcObject = stream;
                await videoEl.play();
                previewWrapper.style.display = "block";
                videoEl.classList.remove("d-none");
                imgEl.classList.add("d-none");
                document.getElementById("stopCameraBtn").classList.remove("d-none");
                window.__cameraStream = stream;
                window.__scanning = true;
                scanLoop();
            } catch(err){
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Kamera tidak terdeteksi atau izin ditolak',
                    confirmButtonText: 'OK'
                });
            }
        }

        function stopCamera(){
            window.__scanning = false;
            if (window.__rafId) {
                cancelAnimationFrame(window.__rafId);
                window.__rafId = null;
            }
            if (window.__cameraStream) {
                window.__cameraStream.getTracks().forEach(t => t.stop());
                window.__cameraStream = null;
            }
            const stopBtn = document.getElementById("stopCameraBtn");
            if (stopBtn) stopBtn.classList.add("d-none");
        }

        function scanLoop(){
            if (!window.__scanning) return;
            const videoEl = document.getElementById("videoPreview");
            const canvas = document.getElementById("qrCanvas");
            const ctx = canvas.getContext("2d");
            if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA) {
                canvas.width = videoEl.videoWidth;
                canvas.height = videoEl.videoHeight;
                ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, canvas.width, canvas.height);
                if (code) {
                    window.__scanning = false;
                    onQrDecoded(code, canvas);
                    stopCamera();
                    return;
                }
            }
            window.__rafId = requestAnimationFrame(scanLoop);
        }

        function onQrDecoded(code, sourceCanvas){
            // Generate ulang QR berdasarkan payload yang terbaca
            try {
                showGeneratedQrImage(code.data);
            } catch(_e) {
                // abaikan jika gagal generate
            }

            // Set hasil scan ke input search menggunakan data mentah
            const searchInput = document.getElementById("contractSearch");
            const qrResultInput = document.getElementById("qrScanResult");
            
            if (searchInput) {
                searchInput.value = code.data;
            }
            if (qrResultInput) {
                qrResultInput.value = code.data;
            }
            
            // Trigger search
            applyFilters();
            
            showSuccess(`QR Code berhasil di-scan! Data: ${code.data}`);
        }

        function showGeneratedQrImage(rawString){
            const previewWrapper = document.getElementById("previewWrapper");
            const imgEl = document.getElementById("imagePreview");
            const videoEl = document.getElementById("videoPreview");
            // Gunakan API yang sama seperti halaman generate, ukuran lebih kecil agar pas di preview
            const size = '160x160';
            const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?data=' + encodeURIComponent(rawString) + '&size=' + size;
            imgEl.src = apiUrl;
            previewWrapper.style.display = "block";
            imgEl.classList.remove("d-none");
            videoEl.classList.add("d-none");
        }

        async function handleClipboardRead(){
            if (!navigator.clipboard || !navigator.clipboard.read) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Peringatan',
                    text: 'Clipboard image API tidak didukung. Coba tekan Ctrl+V pada halaman ini.',
                    confirmButtonText: 'OK'
                });
                return;
            }
            try {
                const items = await navigator.clipboard.read();
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith("image/")) {
                            const blob = await item.getType(type);
                            showImagePreviewAndScan(blob);
                            return;
                        }
                    }
                }
                alert("Tidak ada gambar pada clipboard");
            } catch(err){
                alert("Gagal membaca clipboard. Pastikan beri izin clipboard.");
            }
        }

        function handleClipboardPasteEvent(e){
            if (!e.clipboardData) return;
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                const it = items[i];
                if (it.type && it.type.startsWith("image/")) {
                    const file = it.getAsFile();
                    if (file) {
                        showImagePreviewAndScan(file);
                        e.preventDefault();
                        return;
                    }
                }
            }
        }

        function clearQRResult() {
            const qrResultInput = document.getElementById("qrScanResult");
            const searchInput = document.getElementById("contractSearch");
            
            if (qrResultInput) {
                qrResultInput.value = "";
            }
            if (searchInput) {
                searchInput.value = "";
            }
            
            // Clear preview
            const previewWrapper = document.getElementById("previewWrapper");
            if (previewWrapper) {
                previewWrapper.style.display = "none";
            }
            
            // Trigger search to show all contracts
            applyFilters();
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            initializeSidebar();
            initializeContracts();
            initializeQRScanner();
            setupFileUpload();
            initializePhoneValidation();
            
            // Load user info if available
            const user = localStorage.getItem('user') || '';
            document.getElementById('currentUser').textContent = user;
        });

        // Mobile sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            } else {
                sidebar.classList.add('show');
                overlay.classList.add('show');
            }
        }
    </script>

    <!-- Barang Details Modal -->
    <div class="modal fade" id="barangDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-boxes me-2"></i>
                        Detail Barang - <span id="barangContractTitle"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Barang Actions -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <button class="btn btn-primary" onclick="showAddBarangModal()">
                                <i class="fas fa-plus me-2"></i>Tambah Barang
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="text-muted">
                                Total: <span id="barangTotalCount">0</span> barang
                            </span>
                        </div>
                    </div>

                    <!-- Barang Table -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="barangTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>No</th>
                                    <th>Jenis Barang</th>
                                    <th>Volume (mÂ³)</th>
                                    <th>Berat (kg)</th>
                                    <th>Jumlah Kontainer</th>
                                    <th>Ukuran (ft)</th>
                                    <th>Nomor Kontainer</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="barangTableBody">
                                <!-- Barang data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Contract Modal -->
    <div class="modal fade" id="editContractModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Edit Kontrak
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editContractForm" novalidate>
                        <!-- Informasi Dasar Kontrak -->
                        <div class="section-header mb-3">
                            <h6><i class="fas fa-info-circle me-2"></i>Informasi Dasar Kontrak</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editNamaProyek" class="form-label">
                                    <i class="fas fa-project-diagram me-2"></i>Nama Proyek
                                </label>
                                <input type="text" class="form-control" id="editNamaProyek" 
                                       placeholder="Masukkan nama proyek atau logistik" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editJenisKontrak" class="form-label">
                                    <i class="fas fa-file-contract me-2"></i>Jenis Kontrak
                                </label>
                                <select class="form-select" id="editJenisKontrak" required>
                                    <option value="">Pilih jenis kontrak</option>
                                    <option value="Logistik">Logistik</option>
                                    <option value="Penyimpanan">Penyimpanan</option>
                                    <option value="Bongkar Muat">Bongkar Muat</option>
                                    <option value="Transportasi">Transportasi</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editTglMulai" class="form-label">
                                    <i class="fas fa-calendar-alt me-2"></i>Tanggal Mulai
                                </label>
                                <input type="date" class="form-control" id="editTglMulai" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editTglSelesai" class="form-label">
                                    <i class="fas fa-calendar-check me-2"></i>Tanggal Selesai
                                </label>
                                <input type="date" class="form-control" id="editTglSelesai" required>
                            </div>
                        </div>

                        <!-- Nilai Kontrak -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-dollar-sign me-2"></i>Nilai Kontrak</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editNilaiKontrak" class="form-label">
                                    <i class="fas fa-money-bill-wave me-2"></i>Nilai Kontrak
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text" id="editCurrencySymbol">Rp</span>
                                    <input type="number" class="form-control" id="editNilaiKontrak" 
                                           step="0.01" placeholder="Masukkan nilai kontrak" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editMataUang" class="form-label">
                                    <i class="fas fa-coins me-2"></i>Mata Uang
                                </label>
                                <select class="form-select" id="editMataUang" required>
                                    <option value="">Pilih mata uang</option>
                                    <option value="IDR">IDR (Rupiah)</option>
                                    <option value="USD">USD (Dollar)</option>
                                    <option value="EUR">EUR (Euro)</option>
                                    <option value="SGD">SGD (Singapore Dollar)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Informasi Perusahaan -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-building me-2"></i>Informasi Perusahaan</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="editAlamat" class="form-label">
                                    <i class="fas fa-map-marker-alt me-2"></i>Alamat
                                </label>
                                <textarea class="form-control" id="editAlamat" rows="3" 
                                          placeholder="Masukkan alamat lengkap perusahaan"></textarea>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editKontakResmi" class="form-label">
                                    <i class="fas fa-phone me-2"></i>Kontak Resmi
                                </label>
                                <div class="input-group">
                                    <select class="form-select" id="editCountryCode" style="max-width: 120px;">
                                        <option value="+62">ðŸ‡®ðŸ‡© +62</option>
                                        <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                                        <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                                        <option value="+65">ðŸ‡¸ðŸ‡¬ +65</option>
                                        <option value="+60">ðŸ‡²ðŸ‡¾ +60</option>
                                        <option value="+66">ðŸ‡¹ðŸ‡­ +66</option>
                                        <option value="+63">ðŸ‡µðŸ‡­ +63</option>
                                        <option value="+84">ðŸ‡»ðŸ‡³ +84</option>
                                    </select>
                                    <input type="tel" class="form-control" id="editKontakResmi" 
                                           placeholder="Masukkan nomor telepon" pattern="[0-9\s\-\(\)]+" 
                                           title="Hanya angka, spasi, tanda hubung, dan tanda kurung yang diperbolehkan" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editNamaPic" class="form-label">
                                    <i class="fas fa-user me-2"></i>Nama PIC
                                </label>
                                <input type="text" class="form-control" id="editNamaPic" 
                                       placeholder="Nama lengkap Person in Charge" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editNpwp" class="form-label">
                                    <i class="fas fa-id-card me-2"></i>NPWP
                                </label>
                                <input type="text" class="form-control" id="editNpwp" 
                                       placeholder="Nomor Pokok Wajib Pajak">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editAsuransi" class="form-label">
                                    <i class="fas fa-shield-alt me-2"></i>Asuransi
                                </label>
                                <select class="form-select" id="editAsuransi" required>
                                    <option value="0">Tidak</option>
                                    <option value="1">Ya</option>
                                </select>
                            </div>
                        </div>

                        <!-- Informasi Pembayaran -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-credit-card me-2"></i>Informasi Pembayaran</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editTerminPembayaran" class="form-label">
                                    <i class="fas fa-calendar-week me-2"></i>Termin Pembayaran
                                </label>
                                <select class="form-select" id="editTerminPembayaran" required>
                                    <option value="">Pilih termin pembayaran</option>
                                    <option value="DP">DP (Down Payment)</option>
                                    <option value="Cicilan">Cicilan</option>
                                    <option value="Pelunasan">Pelunasan</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editMetodePembayaran" class="form-label">
                                    <i class="fas fa-money-check-alt me-2"></i>Metode Pembayaran
                                </label>
                                <select class="form-select" id="editMetodePembayaran" required>
                                    <option value="">Pilih metode pembayaran</option>
                                    <option value="Transfer Bank">Transfer Bank</option>
                                    <option value="LC">LC (Letter of Credit)</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                        </div>

                        <!-- Pajak dan Penalti -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-percentage me-2"></i>Pajak dan Penalti</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editPpn" class="form-label">
                                    <i class="fas fa-receipt me-2"></i>PPN (%)
                                </label>
                                <input type="number" class="form-control" id="editPpn" 
                                       step="0.01" value="11.00" placeholder="11.00" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editPajakLainnya" class="form-label">
                                    <i class="fas fa-plus-circle me-2"></i>Pajak Lainnya
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text" id="editPajakCurrencySymbol">Rp</span>
                                    <input type="number" class="form-control" id="editPajakLainnya" 
                                           step="0.01" value="0" placeholder="Nilai pajak tambahan (opsional)">
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editPenaltiTerlambat" class="form-label">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Penalti Terlambat
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text" id="editPenaltiCurrencySymbol">Rp</span>
                                    <input type="number" class="form-control" id="editPenaltiTerlambat" 
                                           step="0.01" value="0" placeholder="Nilai penalti per hari (opsional)">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editHariPenalti" class="form-label">
                                    <i class="fas fa-clock me-2"></i>Hari Penalti
                                </label>
                                <input type="number" class="form-control" id="editHariPenalti" 
                                       value="0" placeholder="Jumlah hari keterlambatan (opsional)">
                            </div>
                        </div>

                        <!-- Dokumen Lampiran -->
                        <div class="section-header mb-3 mt-4">
                            <h6><i class="fas fa-paperclip me-2"></i>Dokumen Lampiran</h6>
                        </div>
                        <div class="mb-3">
                            <input type="file" class="form-control" id="editDokumenLampiran" 
                                   multiple accept=".pdf,.doc,.docx,.xlsx,.xls,.csv,.jpg,.jpeg,.png,.txt,.rtf">
                            <small class="form-text text-muted">Upload dokumen pendukung (PDF, DOC, DOCX, Excel, CSV, JPG, PNG, TXT, RTF)</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="updateContract()">
                        <i class="fas fa-save me-2"></i>Update Kontrak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Barang Modal -->
    <div class="modal fade" id="addBarangModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        <span id="addBarangModalTitle">Tambah Barang Baru</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBarangForm" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="jenisBarang" class="form-label">
                                    <i class="fas fa-tag me-2"></i>Jenis Barang
                                </label>
                                <input type="text" class="form-control" id="jenisBarang" 
                                       placeholder="Masukkan jenis barang" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="volume" class="form-label">
                                    <i class="fas fa-cube me-2"></i>Volume (mÂ³)
                                </label>
                                <input type="number" class="form-control" id="volume" 
                                       step="0.01" placeholder="0.00" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="berat" class="form-label">
                                    <i class="fas fa-weight me-2"></i>Berat (kg)
                                </label>
                                <input type="number" class="form-control" id="berat" 
                                       step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="jumlahKontainer" class="form-label">
                                    <i class="fas fa-shipping-fast me-2"></i>Jumlah Kontainer
                                </label>
                                <input type="number" class="form-control" id="jumlahKontainer" 
                                       min="1" placeholder="1" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="ukuranKontainer" class="form-label">
                                    <i class="fas fa-ruler me-2"></i>Ukuran Kontainer (ft)
                                </label>
                                <select class="form-select" id="ukuranKontainer" required>
                                    <option value="">Pilih ukuran</option>
                                    <option value="20">20 ft</option>
                                    <option value="40">40 ft</option>
                                    <option value="45">45 ft</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="nomorKontainer" class="form-label">
                                    <i class="fas fa-barcode me-2"></i>Nomor Kontainer
                                </label>
                                <input type="text" class="form-control" id="nomorKontainer" 
                                       placeholder="Masukkan nomor kontainer" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveBarang()">
                        <i class="fas fa-save me-2"></i>Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Analysis Modal -->
    <div class="modal fade" id="riskAnalysisModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-heat me-2"></i>Analisis Risiko Kontrak
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Risk Summary</h6>
                            <div id="riskSummary"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Risk Heatmap</h6>
                            <div id="riskHeatmap"></div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h6>Clause Analysis</h6>
                        <div id="clauseAnalysis"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline & Version Control Modal -->
    <div class="modal fade" id="timelineModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-history me-2"></i>Timeline & Version Control
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="timelineTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab">
                                <i class="fas fa-clock me-2"></i>Timeline
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="version-tab" data-bs-toggle="tab" data-bs-target="#version" type="button" role="tab">
                                <i class="fas fa-code-branch me-2"></i>Version Control
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="approval-tab" data-bs-toggle="tab" data-bs-target="#approval" type="button" role="tab">
                                <i class="fas fa-clipboard-check me-2"></i>Approval Workflow
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="timelineTabContent">
                        <div class="tab-pane fade show active" id="timeline" role="tabpanel">
                            <div id="contractTimeline"></div>
                        </div>
                        <div class="tab-pane fade" id="version" role="tabpanel">
                            <div id="versionControl"></div>
                        </div>
                        <div class="tab-pane fade" id="approval" role="tabpanel">
                            <div id="approvalWorkflow"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Log Modal -->
    <div class="modal fade" id="activityLogModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-history me-2"></i>Log Aktivitas User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="date" class="form-control" id="logDateFilter" onchange="filterActivityLog()">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="logUserFilter" onchange="filterActivityLog()">
                                <option value="all">Semua User</option>
                                <option value="admin">Admin</option>
                                <option value="client">Client</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="logActionFilter" onchange="filterActivityLog()">
                                <option value="all">Semua Aksi</option>
                                <option value="login">Login</option>
                                <option value="logout">Logout</option>
                                <option value="create">Buat</option>
                                <option value="update">Update</option>
                                <option value="delete">Hapus</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Waktu</th>
                                    <th>User</th>
                                    <th>Aksi</th>
                                    <th>Deskripsi</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody id="activityLogTable">
                                <!-- Activity log entries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="exportActivityLog()">Export Log</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
